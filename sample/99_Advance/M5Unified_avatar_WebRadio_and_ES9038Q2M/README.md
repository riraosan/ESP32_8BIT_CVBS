# M5Unified_avatar_WebRadio_and_ES9038Q2M

[original source](https://github.com/lovyan03/M5Unified_avatar_WebRadio_LED)はこちら
## 概要

このリポジトリのソースはM5Stack ATOM Liteで動作するWebRadioです。

次の機能を実現できます。

- レベルメーターとスタックチャンの顔をデジタルTVのコンポジットへ表示できます。
  - @riraosanが作成したESP32_8BIT_CVBSライブラリを使用
- スタックチャンとレベルメーターを一つの画面へ出力出来ます。
  - スタックチャンのインスタンスにM5Canvas（スプライト）のポインタを渡せるように改修
- WebRadioからMP3デコード結果をI2S経由で外部DAC(ES9038Q2M)へ出力できます。
  - MP3@192KHz, 44100Hz, 32bit ※16bitでないことに注意してください
- デュアルボタンユニットを使用して、選局とボリューム調整ができます。(Button2ライブラリを使用)

ボタン操作は次の通りです。

|                  | 赤ボタン  | 青ボタン  | 本体ボタン(G39) |
| :--------------: | :------: | :------: | :-------------: |
|  ロングクリック    | 選局(+)  | 選局(-)   |        ✕        |
|  ダブルクリック    | 音量(+)   | 音量(-)   |        ✕        |
|      長押し       |    ✕     |    ✕     |   ATOM再起動    |

## 対応機器

次の構成でこのサンプルプログラムが動作することを確認しました。
**※ご注意：ATOM Lite以外で動作を確認していません。**

- M5Stack ATOM Lite
- ES9038Q2M 中華DAC（メーカー不明）
- デジタルTV（コンポジット入力付）
- [Mini Dual Button Unit](https://shop.m5stack.com/products/mini-dual-button-unit)

## その他

- DACのLOCKが度々外れる場合は、I2Sのバッファカウントとバッファレングスの値を調整してください。setupAudio()内で@riraosanのDACで最適化した設定をおこなっています。

## 使用ライブラリについて

- platformio.iniを同梱しました。使用したライブラリはこのファイルを参照してください。
- patchフォルダに保存しているAudioOutputI2S.cpp, AudioOutputI2S.hはESP8266Audioライブラリ内の同名のファイルを削除して置き換えてください。32bitサンプルのDACを使用できるようになります。16bitサンプルのDACを使用する場合は、ファイルを置き換える必要はありません。
- スタックチャンのフェイスを表示した場合、処理負荷が高くなりますので、WebRadioの動作が不安定になることがあります。ご注意ください。
  - アバターはCPU0, AudioはCPU1, CVBS表示はCPU0を利用しています。この構成で負荷を分散できるようです。

## 謝辞

このサンプルを公開していただきました@@wakwak_koba、@robo8080さん、@lovyan03さんに感謝いたします。ありがとうございました。

どこかのどなたかのなんらかに貢献できましたら幸いです。
